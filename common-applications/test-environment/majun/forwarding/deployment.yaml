apiVersion: apps/v1
kind: Deployment
metadata:
  name: majun-forwarding
  namespace: majun
spec:
  replicas: 0
  selector:
    matchLabels:
      app: forwarding
  strategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'majun'
        vault.hashicorp.com/agent-inject-secret-mongo.crt: 'internal/data/infra-test/majun'
        vault.hashicorp.com/agent-inject-secret-redis.crt: 'internal/data/infra-test/majun'
        vault.hashicorp.com/agent-inject-secret-kafka.crt: 'internal/data/infra-test/majun'
        vault.hashicorp.com/agent-inject-secret-kafka.jks: 'internal/data/infra-test/majun'
        vault.hashicorp.com/agent-pre-populate-only: "true"
        vault.hashicorp.com/agent-inject-perms-mongo.crt: "0400"
        vault.hashicorp.com/agent-inject-perms-redis.crt: "0400"
        vault.hashicorp.com/agent-inject-perms-kafka.crt: "0400"
        vault.hashicorp.com/agent-inject-perms-kafka.jks: "0400"
        vault.hashicorp.com/agent-run-as-user: "1000"
        vault.hashicorp.com/agent-run-as-group: "1000"
        vault.hashicorp.com/secret-volume-path: "/opt/app/majun/cert"
        vault.hashicorp.com/agent-inject-template-mongo.crt: |  
          {{- with secret "internal/data/infra-test/majun" -}}  
          {{ .Data.data.mongoCrt }}
          {{- end }}
        vault.hashicorp.com/agent-inject-template-redis.crt: |  
          {{- with secret "internal/data/infra-test/majun" -}}  
          {{ .Data.data.redisCrt }}
          {{- end }}
        vault.hashicorp.com/agent-inject-template-kafka.crt: |  
          {{- with secret "internal/data/infra-test/majun" -}}  
          {{ .Data.data.kafkaCrt }}
          {{- end }}
        vault.hashicorp.com/agent-inject-template-kafka.jks: |  
          {{- with secret "internal/data/infra-test/majun" -}}  
          {{ base64Decode .Data.data.kafkaJks }}
          {{- end }}
        vault.hashicorp.com/agent-service-account-token-volume-name: "token-vol"
        vault.hashicorp.com/tls-skip-verify: "true"
        vault.hashicorp.com/agent-init-first: "true"
      labels:
        app: forwarding
    spec:
      imagePullSecrets:
      - name: huawei-swr-image-pull-secret
      serviceAccount: majun
      securityContext:
        fsGroup: 1000
        seccompProfile:
          type: Localhost
          localhostProfile: infra-seccomp.json
      automountServiceAccountToken: false
      nodeSelector:
        icsl: "true"
      initContainers:
      - command:
        - /bin/bash
        - -c
        - chmod 0700 /opt/app/majun/cert; chown -R 1000:1000 /opt/app/majun/cert; chmod g-s /opt/app/majun/cert; ls -ld /opt/app/majun/cert
        image: swr.cn-north-4.myhuaweicloud.com/opensourceway/openeuler:22.03-lts-sp3
        imagePullPolicy: IfNotPresent
        name: init-majun
      containers:
      - image: swr.cn-north-4.myhuaweicloud.com/opensourceway/majun/forwarding-beta:icsl_beta-1f631e
        imagePullPolicy: IfNotPresent
        env:
        - name: servicecomb.credentials.accessKey
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: accesskey
        - name: servicecomb.credentials.secretKey
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: secretkey
        - name: rootSalt
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: rootsalt
        - name: X_ARMOR_SECURITY_ENABLE
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_SECURITY_ENABLE
        - name: X_ARMOR_SECURITY_ROOT_PASSWORD_0
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_SECURITY_ROOT_PASSWORD_0
        - name: X_ARMOR_SECURITY_WORK_PASSWORD_0
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_SECURITY_WORK_PASSWORD_0
        - name: X_ARMOR_BACKEND_APP_TOKEN
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_BACKEND_APP_TOKEN
        - name: X_ARMOR_BACKEND_APP_ID
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_BACKEND_APP_ID
        - name: X_ARMOR_BACKEND_BACKEND_URL
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_BACKEND_BACKEND_URL
        - name: X_ARMOR_BACKEND_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: majun-secret
              key: X_ARMOR_BACKEND_TENANT_ID
        volumeMounts:
        - mountPath: /opt/app/work/tcwFile.ks
          name: majun-secret
          subPath: tcwFile5-ks
        - mountPath: /opt/app/primary/ocpFile.ks
          name: majun-secret
          subPath: tcpFile5-ks
        - mountPath: /opt/app/standby/tcsFile.ks
          name: majun-secret
          subPath: tcsFile5-ks
        livenessProbe:
          failureThreshold: 3
          initialDelaySeconds: 25
          periodSeconds: 3
          successThreshold: 1
          httpGet:
            scheme: HTTP
            path: /majun-service-forwarding/health-check/checkStart
            port: 8083
          timeoutSeconds: 5
        name: forwarding
        readinessProbe:
          failureThreshold: 3
          initialDelaySeconds: 25
          periodSeconds: 3
          successThreshold: 1
          httpGet:
            scheme: HTTP
            path: /majun-service-forwarding/health-check/checkStart
            port: 8083
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 2000m
            memory: 3000Mi
          requests:
            cpu: 2000m
            memory: 3000Mi
        securityContext:
          allowPrivilegeEscalation: false
          runAsUser: 1000
          runAsGroup: 1000
          capabilities:
            drop:
              - ALL
      volumes:
      - name: majun-secret
        secret:
          defaultMode: 256
          secretName: majun-secret
      - name: token-vol
        projected:
          sources:
          - serviceAccountToken:
              audience: api
              expirationSeconds: 600
              path: token
