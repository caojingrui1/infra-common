apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: etherpad
  name: etherpad
  namespace: etherpad
spec:
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: etherpad
  template:
    metadata:
      labels:
        app: etherpad
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - etherpad
            topologyKey: kubernetes.io/hostname
      imagePullSecrets:
      - name: huawei-swr-image-pull-secret
      nodeSelector:
        autoscaler: "true"
      containers:
      - env:
        - name: DB_TYPE
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_type
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_host
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_port
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_user
        - name: DB_PASS
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_pass
        - name: DB_CHARSET
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_charset
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: db_name
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: admin_password
        - name: SKIN_NAME
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: skin_name
        - name: CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: client_id
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: client_secret
        - name: ISSUER_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: issuer_client_id
        - name: ISSUER_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: etherpad-secrets
              key: issuer_client_secret
        - name: ISSUER_AUTHORIZATION_ENDPOINT
          value: "https://openeuler-usercenter.test.osinfra.cn/oneid/oidc/authorize"
        - name: ISSUER_TOKEN_ENDPOINT
          value: "https://openeuler-usercenter.test.osinfra.cn/oneid/oidc/token"
        - name: ISSUER_USERINFO_ENDPOINT
          value: "https://openeuler-usercenter.test.osinfra.cn/oneid/oidc/user"
        - name: ISSUER_ENDPOINT
          value: "https://openeulertest.authing.cn/oidc"
        - name: ISSUER_JWKS_URI
          value: "https://openeuler-usercenter.test.osinfra.cn"
        - name: ISSUER_BASE_URL
          value: "https://etherpad.test.osinfra.cn"
        - name: REQUIRE_AUTHENTICATION
          value: "true"
        - name: OSSCHECKURL
          value: "https://omapi.test.osinfra.cn/oneid/user/permission?community=openeuler"
        - name: OSOSSLOGOUTURL
          value: "https://openeuler-usercenter.test.osinfra.cn/logout"
        image: swr.cn-north-4.myhuaweicloud.com/opensourceway/common/etherpad:1.8.18
        imagePullPolicy: IfNotPresent
        name: etherpad
        ports:
        - containerPort: 9001
          name: http
          protocol: TCP
        resources:
          requests:
            cpu: 500m
            memory: 500Mi
          limits:
            cpu: 500m
            memory: 500Mi
        volumeMounts:
        - mountPath: /opt/etherpad-lite/var
          name: data-volume
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: etherpad-data-volume
          
